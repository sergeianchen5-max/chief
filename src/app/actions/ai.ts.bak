'use server';

import { ChefPlan, FamilyMember, Ingredient, Gender, GoalType, ActivityLevel, MealCategory, MEAL_CATEGORIES } from "@/lib/types";
import { generatePlanSchema } from "@/lib/schemas";

// –¢–∏–ø —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –ø–µ—Ä–µ–¥–∞—á–∏ –æ—à–∏–±–æ–∫ –≤ production
export type GenerateResult =
    | { success: true; data: ChefPlan }
    | { success: false; error: string };

// ===================== –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø =====================

const OPENROUTER_API_URL = "https://openrouter.ai/api/v1/chat/completions";
const GEMINI_API_URL_BASE = "https://generativelanguage.googleapis.com/v1beta/models";

// Fallback-–º–æ–¥–µ–ª–∏ OpenRouter (–¢–æ–ª—å–∫–æ —Å–∞–º—ã–µ –±—ã—Å—Ç—Ä—ã–µ –∏ –¥–æ—Å—Ç—É–ø–Ω—ã–µ!)
const OPENROUTER_MODELS = [
    "meta-llama/llama-3.3-70b-instruct:free",           // Llama 3.3
    "google/gemma-3-27b-it:free",                       // Gemma 3
    "nousresearch/hermes-3-llama-3.1-405b:free",        // Hermes 3 (405B!)
    "deepseek/deepseek-r1:free",                        // DeepSeek R1 (—É–º–Ω–∞—è)
    "mistralai/mistral-small-24b-instruct-2501:free",   // Mistral Small 3
    "microsoft/phi-3-medium-128k-instruct:free",        // Phi-3
];

const SITE_URL = process.env.VERCEL_URL
    ? `https://${process.env.VERCEL_URL}`
    : "https://schef-xi.vercel.app";

function sleep(ms: number) {
    return new Promise(resolve => setTimeout(resolve, ms));
}

// ===================== GEMINI API (–û–°–ù–û–í–ù–û–ô) - REST =====================

async function callGemini(systemPrompt: string, userPrompt: string): Promise<string> {
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
        throw new Error("GEMINI_API_KEY –Ω–µ –∑–∞–¥–∞–Ω");
    }

    console.log(`[Gemini] üöÄ –ó–∞–ø—Ä–æ—Å –∫ Gemini 1.5 Flash (REST)...`);

    try {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), 15000); // 15 —Å–µ–∫—É–Ω–¥ —Ç–∞–π–º–∞—É—Ç

        const url = `${GEMINI_API_URL_BASE}/gemini-1.5-flash:generateContent?key=${apiKey}`;

        const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                contents: [{ role: "user", parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    temperature: 0.5,
                    maxOutputTokens: 4000
                }
            }),
            signal: controller.signal
        });

        clearTimeout(timeout);

        if (!response.ok) {
            const errText = await response.text();
            throw new Error(`Gemini Error ${response.status}: ${errText.substring(0, 200)}`);
        }

        const data = await response.json();
        const content = data?.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!content || content.trim().length === 0) {
            throw new Error("Gemini –≤–µ—Ä–Ω—É–ª –ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç");
        }

        console.log(`[Gemini] ‚úÖ –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω (${content.length} —Å–∏–º–≤–æ–ª–æ–≤)`);
        return content;

    } catch (error: any) {
        if (error.name === 'AbortError') {
            console.warn(`[Gemini] ‚è∞ –¢–∞–π–º–∞—É—Ç (15—Å)`);
            throw new Error("Gemini timeout (15s)");
        }
        console.warn(`[Gemini] ‚ö†Ô∏è –û—à–∏–±–∫–∞: ${error.message}`);
        throw error;
    }
}

// ===================== OPENROUTER API (FALLBACK) =====================

async function callOpenRouter(systemPrompt: string, userPrompt: string): Promise<string> {
    const apiKey = process.env.OPENROUTER_API_KEY;
    if (!apiKey) {
        throw new Error("OPENROUTER_API_KEY –Ω–µ –∑–∞–¥–∞–Ω –≤ .env.local");
    }

    // –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –º–æ–¥–µ–ª–∏
    for (const model of OPENROUTER_MODELS) {
        console.log(`[OpenRouter] üöÄ –ü—Ä–æ–±—É–µ–º ${model}...`);

        // –î–ª—è –∫–∞–∂–¥–æ–π –º–æ–¥–µ–ª–∏ –¥–µ–ª–∞–µ–º –¥–æ 2 –ø–æ–ø—ã—Ç–æ–∫ –ø—Ä–∏ 429
        for (let attempt = 0; attempt < 2; attempt++) {
            if (attempt > 0) {
                console.log(`[OpenRouter] ‚è≥ –ü–∞—É–∑–∞ –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º –¥–ª—è ${model}...`);
                await sleep(2000 * attempt); // 2 —Å–µ–∫, –ø–æ—Ç–æ–º –±–æ–ª—å—à–µ
            }

            try {
                const controller = new AbortController();
                const timeout = setTimeout(() => controller.abort(), 20000); // 20 —Å–µ–∫—É–Ω–¥ –º–∞–∫—Å

                const response = await fetch(OPENROUTER_API_URL, {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${apiKey}`,
                        "Content-Type": "application/json",
                        "HTTP-Referer": SITE_URL,
                        "X-Title": "Schef Fridge",
                    },
                    body: JSON.stringify({
                        model,
                        messages: [
                            { role: "system", content: systemPrompt },
                            { role: "user", content: userPrompt },
                        ],
                        temperature: 0.5,
                        max_tokens: 4000,
                    }),
                    signal: controller.signal,
                });

                clearTimeout(timeout);

                if (response.status === 429) {
                    console.warn(`[OpenRouter] ‚ö†Ô∏è 429 Rate Limit –¥–ª—è ${model}. –ü–æ–ø—ã—Ç–∫–∞ ${attempt + 1}/2.`);
                    continue; // –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Ü–∏–∫–ª)
                }

                if (!response.ok) {
                    const errorBody = await response.text();
                    console.error(`[OpenRouter] ‚ùå ${response.status} –æ—Ç ${model}:`, errorBody.substring(0, 200));
                    break; // –ù–µ –ø–æ–≤—Ç–æ—Ä—è—Ç—å –¥–ª—è —ç—Ç–æ–π –º–æ–¥–µ–ª–∏ (–ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–π)
                }

                const data = await response.json() as any;
                const content = data?.choices?.[0]?.message?.content;

                if (!content || content.trim().length === 0) {
                    console.warn(`[OpenRouter] ‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç ${model}.`);
                    break;
                }

                console.log(`[OpenRouter] ‚úÖ –£—Å–ø–µ—Ö: ${model}`);
                return content;

            } catch (error: any) {
                if (error.name === 'AbortError') {
                    console.warn(`[OpenRouter] ‚è∞ –¢–∞–π–º–∞—É—Ç 20—Å –¥–ª—è ${model}.`);
                } else {
                    console.error(`[OpenRouter] ‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ ${model}:`, error.message);
                }
                break; // –û—à–∏–±–∫–∞ —Å–µ—Ç–∏/—Ç–∞–π–º–∞—É—Ç -> —Å–ª–µ–¥—É—é—â–∞—è –º–æ–¥–µ–ª—å
            }
        }
    }

    throw new Error("–í—Å–µ –º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã (–ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω—ã 429 –∏–ª–∏ 404). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.");
}

// ===================== –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –í–´–ó–û–í =====================

async function callAI(systemPrompt: string, userPrompt: string): Promise<string> {
    // 1. Gemini ‚Äî –æ—Å–Ω–æ–≤–Ω–æ–π
    try {
        return await callGemini(systemPrompt, userPrompt);
    } catch (error: any) {
        console.warn(`[AI] ‚ö†Ô∏è Gemini –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}. –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ OpenRouter...`);
    }

    // 2. OpenRouter ‚Äî fallback
    return await callOpenRouter(systemPrompt, userPrompt);
}

// –ò–∑–≤–ª–µ–∫–∞–µ—Ç JSON –∏–∑ –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏
function extractJSON(text: string): string {
    let cleaned = text.replace(/<think>[\s\S]*?<\/think>/g, '').trim();

    const jsonBlockMatch = cleaned.match(/```(?:json)?\s*\n?([\s\S]*?)\n?```/);
    if (jsonBlockMatch) return jsonBlockMatch[1].trim();

    const jsonObjMatch = cleaned.match(/\{[\s\S]*\}/);
    if (jsonObjMatch) return jsonObjMatch[0].trim();

    const jsonArrMatch = cleaned.match(/\[[\s\S]*\]/);
    if (jsonArrMatch) return jsonArrMatch[0].trim();

    return cleaned;
}

// ===================== –ì–ï–ù–ï–†–ê–¶–ò–Ø –ú–ï–ù–Æ =====================

const SYSTEM_PROMPT = `–¢—ã ‚Äî JSON-–≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –º–µ–Ω—é. –û—Ç–≤–µ—á–∞–π –°–¢–†–û–ì–û –¢–û–õ–¨–ö–û –≤–∞–ª–∏–¥–Ω—ã–º JSON. –ë–µ–∑ —Ç–µ–∫—Å—Ç–∞ –¥–æ –∏–ª–∏ –ø–æ—Å–ª–µ JSON. –ë–µ–∑ markdown-–æ–±—ë—Ä—Ç–æ–∫. –ë–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π. –¢–æ–ª—å–∫–æ JSON.`;

// –ú–∞–ø–ø–∏–Ω–≥ –∫–∞—Ç–µ–≥–æ—Ä–∏–π ‚Üí –æ–ø–∏—Å–∞–Ω–∏–µ –¥–ª—è –ø—Ä–æ–º–ø—Ç–∞
const CATEGORY_PROMPT_MAP: Record<MealCategory, string> = {
    breakfast: '–ó–∞–≤—Ç—Ä–∞–∫: 1-2 –±–ª—é–¥–∞ (–∫–∞—à–∏, –æ–º–ª–µ—Ç—ã, —Å—ã—Ä–Ω–∏–∫–∏, –±—É—Ç–µ—Ä–±—Ä–æ–¥—ã)',
    salad: '–°–∞–ª–∞—Ç—ã –∏ –∑–∞–∫—É—Å–∫–∏: 1-2 –±–ª—é–¥–∞ (—Å–≤–µ–∂–∏–µ, —Ç—ë–ø–ª—ã–µ, –ª—ë–≥–∫–∏–µ)',
    soup: '–ü–µ—Ä–≤–æ–µ –±–ª—é–¥–æ (—Å—É–ø): 1 –±–ª—é–¥–æ (–±–æ—Ä—â, —â–∏, –∫—Ä–µ–º-—Å—É–ø, –±—É–ª—å–æ–Ω)',
    main: '–í—Ç–æ—Ä–æ–µ –±–ª—é–¥–æ: 1-2 –±–ª—é–¥–∞ (–º—è—Å–æ, —Ä—ã–±–∞, –ø—Ç–∏—Ü–∞ + –≥–∞—Ä–Ω–∏—Ä)',
    dessert: '–î–µ—Å–µ—Ä—Ç/–≤—ã–ø–µ—á–∫–∞: 1 –±–ª—é–¥–æ (–ø–∏—Ä–æ–∂–∫–∏, —Ç–æ—Ä—Ç, –±–ª–∏–Ω—ã —Å –Ω–∞—á–∏–Ω–∫–æ–π)',
    drink: '–ù–∞–ø–∏—Ç–æ–∫: 1 (–∫–æ–º–ø–æ—Ç, —Å–º—É–∑–∏, –º–æ—Ä—Å, –∫–∏—Å–µ–ª—å)',
};

export async function generateChefPlan(
    inventory: Ingredient[],
    family: FamilyMember[],
    onlyFridge: boolean,
    categories: MealCategory[] = ['breakfast', 'soup', 'main', 'dessert']
): Promise<GenerateResult> {

    let activeFamily = family;
    if (!activeFamily || activeFamily.length === 0) {
        activeFamily = [{
            id: 'default', name: '–¢–µ—Å—Ç–µ—Ä', age: 30, gender: Gender.MALE,
            height: 180, weight: 75, activityLevel: ActivityLevel.MODERATE,
            goal: GoalType.MAINTENANCE, preferences: '–í—Å–µ—è–¥–Ω—ã–π'
        }];
    }

    const validation = generatePlanSchema.safeParse({ inventory, family: activeFamily, onlyFridge, categories });
    if (!validation.success) {
        return { success: false, error: "–û—à–∏–±–∫–∞ –≤–∞–ª–∏–¥–∞—Ü–∏–∏: " + validation.error.message };
    }

    const inventoryList = (inventory.length > 0 ? inventory.map(i => i.name).join(", ") : "–ü—É—Å—Ç–æ–π —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫") + ", –í–æ–¥–∞, –°–æ–ª—å, –ü–µ—Ä–µ—Ü";

    const familyProfiles = activeFamily.map(f =>
        `- ${f.name}: ${f.gender}, ${f.age} –ª–µ—Ç, ${f.height}—Å–º, ${f.weight}–∫–≥. –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${f.activityLevel}. –¶–µ–ª—å: ${f.goal}. –ü—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è: ${f.preferences}.`
    ).join("\n");

    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –±–ª—é–¥ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    const menuItems = categories
        .map(cat => `- ${CATEGORY_PROMPT_MAP[cat]}`)
        .join("\n");

    const prompt = `–ü—Ä–æ–¥—É–∫—Ç—ã: ${inventoryList}
–°–µ–º—å—è (${activeFamily.length} —á–µ–ª.):
${familyProfiles}

–¢–æ–ª—å–∫–æ –∏–∑ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞: ${onlyFridge ? '–î–ê' : '–ù–ï–¢'}.

–°–æ–∑–¥–∞–π –º–µ–Ω—é:
${menuItems}

–î–ª—è –∫–∞–∂–¥–æ–≥–æ: –∫—Ä–∞—Ç–∫–∏–µ –ø–æ—à–∞–≥–æ–≤—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –∏–Ω–≥—Ä–µ–¥–∏–µ–Ω—Ç—ã —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º, –ö–ë–ñ–£, –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –Ω–æ—Ä–º—ã –∫–∞–∂–¥–æ–≥–æ —á–ª–µ–Ω–∞ —Å–µ–º—å–∏.
–°–ø–∏—Å–æ–∫ –ø–æ–∫—É–ø–æ–∫: reason = –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–µ—Ü–µ–ø—Ç–∞.
–í–°–Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º.

JSON:
{
  "summary": "–∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ",
  "recipes": [
    {
      "name": "–Ω–∞–∑–≤–∞–Ω–∏–µ",
      "description": "–æ–ø–∏—Å–∞–Ω–∏–µ",
      "cookingTimeMinutes": 30,
      "difficulty": "–ª–µ–≥–∫–æ|—Å—Ä–µ–¥–Ω–µ|—Å–ª–æ–∂–Ω–æ",
      "ingredientsToUse": ["–ù–∞–∑–≤–∞–Ω–∏–µ (–ö–æ–ª-–≤–æ)"],
      "missingIngredients": ["–ù–∞–∑–≤–∞–Ω–∏–µ (–ö–æ–ª-–≤–æ)"],
      "healthBenefits": "–ø–æ–ª—å–∑–∞",
      "weightPerServing": "250–≥",
      "totalWeightForFamily": "1–∫–≥",
      "caloriesPerServing": "350 –∫–∫–∞–ª",
      "protein": "25–≥",
      "fats": "15–≥",
      "carbs": "30–≥",
      "instructions": ["—à–∞–≥ 1", "—à–∞–≥ 2"],
      "mealType": ["–ó–∞–≤—Ç—Ä–∞–∫"],
      "familySuitability": [
        {
          "memberName": "–ò–º—è",
          "percentage": 85,
          "reason": "–ø—Ä–∏—á–∏–Ω–∞",
          "nutritionStats": {
            "caloriesPercent": 14,
            "proteinPercent": 20,
            "fatPercent": 18,
            "carbPercent": 10
          }
        }
      ]
    }
  ],
  "shoppingList": [
    { "name": "–ø—Ä–æ–¥—É–∫—Ç", "quantity": "–∫–æ–ª-–≤–æ", "reason": "–ù–∞–∑–≤–∞–Ω–∏–µ –†–µ—Ü–µ–ø—Ç–∞" }
  ]
}`;

    try {
        const rawResponse = await callAI(SYSTEM_PROMPT, prompt);
        const jsonStr = extractJSON(rawResponse);
        const plan = JSON.parse(jsonStr) as ChefPlan;
        console.log(`[AI] ‚úÖ –ú–µ–Ω—é: ${plan.recipes?.length || 0} —Ä–µ—Ü–µ–ø—Ç–æ–≤`);
        return { success: true, data: plan };
    } catch (error: any) {
        console.error("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –º–µ–Ω—é:", error.message);
        return { success: false, error: error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞' };
    }
}

// ===================== –†–ê–°–ü–û–ó–ù–ê–í–ê–ù–ò–ï –ü–†–û–î–£–ö–¢–û–í =====================

const VISION_MODELS = [
    "google/gemma-3-27b-it:free",
    "meta-llama/llama-3.3-70b-instruct:free",
];

export async function recognizeIngredients(base64Image: string): Promise<Ingredient[]> {
    if (!base64Image) throw new Error("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ");

    // 1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å Gemini Vision
    try {
        const apiKey = process.env.GEMINI_API_KEY;
        if (apiKey) {
            console.log(`[Vision] üöÄ Gemini Vision (REST)...`);

            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 15000); // 15s

            const base64Data = base64Image.replace(/^data:image\/\w+;base64,/, "");
            const url = `${GEMINI_API_URL_BASE}/gemini-1.5-flash:generateContent?key=${apiKey}`;

            const response = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    contents: [{
                        role: "user",
                        parts: [
                            { inlineData: { mimeType: "image/jpeg", data: base64Data } },
                            { text: `–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ñ–æ—Ç–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ü–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã.\n–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –¢–û–õ–¨–ö–û –í–ê–õ–ò–î–ù–´–ú JSON –º–∞—Å—Å–∏–≤–æ–º:\n[{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ (RU)", "category": "produce|dairy|meat|pantry|frozen|other"}]` }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 1000
                    }
                }),
                signal: controller.signal
            });

            clearTimeout(timeout);

            if (response.ok) {
                const data = await response.json();
                const content = data?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (content) {
                    const jsonStr = extractJSON(content);
                    const rawItems = JSON.parse(jsonStr);
                    if (Array.isArray(rawItems)) {
                        console.log(`[Vision] ‚úÖ Gemini —Ä–∞—Å–ø–æ–∑–Ω–∞–ª ${rawItems.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤`);
                        return rawItems.map((item: any) => ({
                            id: Date.now().toString() + Math.random().toString().slice(2, 6),
                            name: item.name,
                            category: item.category || 'other'
                        }));
                    }
                }
            } else {
                console.warn(`[Vision] ‚ö†Ô∏è Gemini Error: ${response.status}`);
            }
        }
    } catch (error: any) {
        console.warn(`[Vision] ‚ö†Ô∏è Gemini Vision –æ—à–∏–±–∫–∞: ${error.message}. Fallback –Ω–∞ OpenRouter...`);
    }

    // 2. OpenRouter fallback
    const apiKey = process.env.OPENROUTER_API_KEY;
    if (!apiKey) throw new Error("OPENROUTER_API_KEY –Ω–µ –∑–∞–¥–∞–Ω");

    const base64Data = base64Image.replace(/^data:image\/\w+;base64,/, "");

    for (let modelIdx = 0; modelIdx < VISION_MODELS.length; modelIdx++) {
        const model = VISION_MODELS[modelIdx];
        console.log(`[Vision] üëÅÔ∏è –ü—Ä–æ–±—É–µ–º ${model}...`);

        try {
            const controller = new AbortController();
            const timeout = setTimeout(() => controller.abort(), 20000); // 20 —Å–µ–∫

            const response = await fetch(OPENROUTER_API_URL, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${apiKey}`,
                    "Content-Type": "application/json",
                    "HTTP-Referer": SITE_URL,
                    "X-Title": "Schef Fridge",
                },
                body: JSON.stringify({
                    model,
                    messages: [
                        {
                            role: "user",
                            content: [
                                { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Data}` } },
                                {
                                    type: "text",
                                    text: `–ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ñ–æ—Ç–æ —Ö–æ–ª–æ–¥–∏–ª—å–Ω–∏–∫–∞ –∏–ª–∏ –ø—Ä–æ–¥—É–∫—Ç–æ–≤. –ü–µ—Ä–µ—á–∏—Å–ª–∏ –í–°–ï –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤–∏–¥–∏—à—å.
–û–¢–í–ï–¢–¨ –°–¢–†–û–ì–û –¢–û–õ–¨–ö–û –í–ê–õ–ò–î–ù–´–ú JSON –º–∞—Å—Å–∏–≤–æ–º –æ–±—ä–µ–∫—Ç–æ–≤ (–±–µ–∑ Markdown, –±–µ–∑ 'json'):
[{"name": "–ù–∞–∑–≤–∞–Ω–∏–µ (RU)", "category": "produce|dairy|meat|pantry|frozen|other"}]`
                                }
                            ]
                        }
                    ],
                    temperature: 0.1,
                    max_tokens: 1000,
                }),
                signal: controller.signal,
            });

            clearTimeout(timeout);

            if (response.status === 429) {
                console.warn(`[Vision] ‚è≥ 429 –æ—Ç ${model}.`);
                continue;
            }

            if (!response.ok) {
                const errorBody = await response.text();
                console.error(`[OpenRouter] ‚ùå ${response.status} –æ—Ç ${model}:`, errorBody.substring(0, 200));
                continue;
            }

            const data = await response.json() as any;
            const content = data?.choices?.[0]?.message?.content;

            if (!content) {
                console.warn(`[Vision] ‚ö†Ô∏è –ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç –æ—Ç ${model}`);
                continue;
            }

            console.log(`[Vision] ‚úÖ –£—Å–ø–µ—Ö (${model})`);

            const jsonStr = extractJSON(content);
            const rawItems = JSON.parse(jsonStr);

            if (!Array.isArray(rawItems)) throw new Error("–û—Ç–≤–µ—Ç –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º");

            return rawItems.map((item: any) => ({
                id: Date.now().toString() + Math.random().toString().slice(2, 6),
                name: item.name,
                category: item.category || 'other'
            }));

        } catch (error: any) {
            console.error(`[Vision] üí• –û—à–∏–±–∫–∞ ${model}:`, error.message);
        }
    }

    throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã. –í—Å–µ Vision-–º–æ–¥–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã –∏–ª–∏ –Ω–µ –ø–æ–Ω—è–ª–∏ —Ñ–æ—Ç–æ.");
}
